# DAY 30: Common Issues & Troubleshooting

This guide details the step-by-step troubleshooting process for the most common errors encountered during the 30-day challenge, focusing on firewall, connectivity, and configuration issues.

## 1. Issue: Elastic Agent Fails to Enroll (Fleet Server)

**Symptom 1:** The agent install command fails with connection timed out.

**Symptom 2:** The install command fails with x509: certificate signed by unknown authority.

### Cause (Connection Timed Out):
The Fleet Server's required ports (e.g., 8220) are not accessible from the agent. This can be due to:
- A cloud firewall (like Vultr's) blocking the connection.
- The Fleet Server's own internal firewall (ufw) blocking the port.

### Solution (Connection Timed Out):
- Check Fleet UI: In Kibana, go to Management -> Fleet -> Settings. Check the "Fleet Server hosts" URL to confirm the correct port (e.g., 8220).
- Check Agent Command: Ensure the port in your install command matches the port in the Fleet settings (e.g., https://:8220).
- Allow Port on Fleet Server: SSH into the Fleet Server and open the port on its local firewall:
  ```
  ufw allow 8220
  ```
  (If using HTTPS/443): 
  ```
  ufw allow 443
  ```
- Allow Port on Cloud Firewall: Ensure any cloud firewall (Vultr) allows traffic to this port from the agent's IP.

### Cause (x509 Certificate Error):
The agent does not trust the self-signed certificate generated by the Fleet Server.

### Solution (x509 Certificate Error):
Add the --insecure flag to the agent installation command. This tells the agent to bypass certificate validation.

**Command:**
```
sudo ./elastic-agent install --url=... --enrollment-token=... --insecure
```

## 2. Issue: Agent is "Unhealthy" or "N/A" (No CPU/Memory)

**Symptom:** In the Kibana Fleet UI, the agent is enrolled but shows "N/A" for CPU/Memory, or logs are not arriving.

### Cause:
The agent can talk to the Fleet Server (for enrollment), but it cannot talk to the Elasticsearch server (to send data).
This is almost always a firewall issue blocking the Elasticsearch port (default 9200).

### Solution:
- Check Cloud Firewall: Go to your Vultr (or cloud provider) firewall settings.
- Add a rule to allow TCP traffic on port 9200 from your agent's IP address (or "Anywhere" for testing, though less secure).
- Check Server Firewall: SSH to the Elasticsearch server and allow the port:
  ```
  ufw allow 9200
  ```
- Refresh the Fleet UI after a few minutes; the agent status should update to "Healthy" and data will begin to flow.

## 3. Issue: Kibana "Connection Timed Out" (Initial Setup)

**Symptom:** You cannot access the Kibana web UI (on port 5601) from your browser.

### Cause:
A firewall is blocking port 5601. This can be the cloud firewall or the server's local firewall.

### Solution:
- Cloud Firewall: In Vultr, add a rule to your firewall group to allow TCP traffic on port 5601 from My IP.
- Server Firewall: SSH into the ELK server and run:
  ```
  ufw allow 5601
  ```
- Refresh your browser.

## 4. Issue: osTicket Connector Fails (Timeout)

**Symptom:** The webhook test from Kibana to osTicket fails with a "request failed timeout" error.

### Cause:
The ELK server and the osTicket server cannot communicate on the private network.
One or both servers may not have their private VPC IP address properly configured.
This is common on Windows, where the private adapter may default to an unassigned 169.x.x.x address.

### Solution:
- SSH to ELK Server: Get its private IP (e.g., 172.31.0.3).
- RDP to osTicket Server: Open cmd and type ipconfig.
- Verify IP: Check the "Ethernet adapter" for the VPC. If it shows a 169.x.x.x address, it's unconfigured.
- Set Static IP (Windows):
  - Go to Control Panel -> Network and Internet -> Change adapter settings.
  - Right-click the correct adapter -> Properties -> TCP/IPv4.
  - Select Use the following IP address.
  - IP Address: 172.31.0.5 (Your osTicket private IP)
  - Subnet Mask: 255.255.255.0
  - Click OK.
- Retest Ping: From the ELK server, ping the osTicket private IP again. It should now be successful.
- Update Connector: In Kibana, edit the osTicket connector URL to use the private IP: http://172.31.0.5/osTicket/upload/api/tickets.xml.
- Rerun the test.

## 5. Issue: osTicket/phpMyAdmin Login Errors

**Symptom 1:** osTicket installer fails, saying the database was not created.

**Symptom 2:** Cannot log into phpMyAdmin (Access denied for user 'PMA' or invalid settings).

### Cause (osTicket):
The installer does not create the database; it only configures it. The database must be created manually first.

### Solution (osTicket):
- Go to phpMyAdmin.
- Click New.
- Create the database (e.g., mydfir-30-day-db).
- Go to User accounts -> root (for your public IP) -> Databases.
- Select the new database and grant Check all privileges.
- Re-run the osTicket installer using the exact same database name.

### Cause (phpMyAdmin):
The config.inc.php file was updated with the public IP and new password before the database users were granted remote login privileges.

### Solution (phpMyAdmin):
- Edit C:\xamp\phpMyAdmin\config.inc.php.
- Change $cfg['Servers'][$i]['host'] back to 127.0.0.1.
- Leave the password fields blank for now. Save the file.
- Access phpMyAdmin (it will now work).
- Go to User accounts and grant remote privileges/set passwords for the root and pma users (as done on Day 24).
- Re-edit config.inc.php. Now, set the host to your public IP and add the new passwords.
- Save, and the login will work.

